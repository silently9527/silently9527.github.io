---
title: 11 å¦‚ä½•é«˜æ•ˆçš„ä½¿ç”¨å¹¶è¡Œæµ
author: Herman
updateTime: 2021-08-14 13:41
desc: å¦‚ä½•é«˜æ•ˆçš„ä½¿ç”¨å¹¶è¡Œæµ
categories: Java
tags: Java8æ–°ç‰¹æ€§/å¤šçº¿ç¨‹
outline: deep
---


åœ¨Java7ä¹‹å‰æƒ³è¦å¹¶è¡Œå¤„ç†å¤§é‡æ•°æ®æ˜¯å¾ˆå›°éš¾çš„ï¼Œé¦–å…ˆæŠŠæ•°æ®æ‹†åˆ†æˆå¾ˆå¤šä¸ªéƒ¨åˆ†ï¼Œç„¶åæŠŠè¿™è¿™äº›å­éƒ¨åˆ†æ”¾å…¥åˆ°æ¯ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œè®¡ç®—é€»è¾‘ï¼Œæœ€ååœ¨æŠŠæ¯ä¸ªçº¿ç¨‹è¿”å›çš„è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶æ“ä½œï¼›åœ¨Java7ä¸­æä¾›äº†ä¸€ä¸ªå¤„ç†å¤§æ•°æ®çš„fork/joinæ¡†æ¶ï¼Œå±è”½æ‰äº†çº¿ç¨‹ä¹‹é—´äº¤äº’çš„å¤„ç†ï¼Œæ›´åŠ ä¸“æ³¨äºæ•°æ®çš„å¤„ç†ã€‚

---

#### Fork/Joinæ¡†æ¶
Fork/Joinæ¡†æ¶é‡‡ç”¨çš„æ˜¯æ€æƒ³å°±æ˜¯åˆ†è€Œæ²»ä¹‹ï¼ŒæŠŠå¤§çš„ä»»åŠ¡æ‹†åˆ†æˆå°çš„ä»»åŠ¡ï¼Œç„¶åæ”¾å…¥åˆ°ç‹¬ç«‹çš„çº¿ç¨‹ä¸­å»è®¡ç®—ï¼ŒåŒæ—¶ä¸ºäº†æœ€å¤§é™åº¦çš„åˆ©ç”¨å¤šæ ¸CPUï¼Œé‡‡ç”¨äº†ä¸€ä¸ªç§`å·¥ä½œçªƒå–`çš„ç®—æ³•æ¥è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æŸä¸ªçº¿ç¨‹å¤„ç†å®Œè‡ªå·±å·¥ä½œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åï¼Œå°è¯•å½“å…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•ã€‚æ‰€ä»¥ä¸ºäº†å‡å°‘çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€šå¸¸ä¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼›åœ¨ç™¾åº¦æ‰¾äº†ä¸€å¼ å›¾

![](https://raw.githubusercontent.com/silently9527/images/main/1491165985-5fc1b9ba8ea44_articlex)

- ä½¿ç”¨`RecursiveTask`
ä½¿ç”¨Fork/Joinæ¡†æ¶é¦–å…ˆéœ€è¦åˆ›å»ºè‡ªå·±çš„ä»»åŠ¡ï¼Œéœ€è¦ç»§æ‰¿`RecursiveTask`ï¼Œå®ç°æŠ½è±¡æ–¹æ³•

```
protected abstract V compute();
```
å®ç°ç±»éœ€è¦åœ¨è¯¥æ–¹æ³•ä¸­å®ç°ä»»åŠ¡çš„æ‹†åˆ†ï¼Œè®¡ç®—ï¼Œåˆå¹¶ï¼›ä¼ªä»£ç å¯ä»¥è¡¨ç¤ºæˆè¿™æ ·ï¼š

```
if(ä»»åŠ¡å·²ç»ä¸å¯æ‹†åˆ†){
    return é¡ºåºè®¡ç®—ç»“æœ;
} else {
    1.ä»»åŠ¡æ‹†åˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡
    2.é€’å½’è°ƒç”¨æœ¬æ–¹æ³•ï¼Œæ‹†åˆ†å­ä»»åŠ¡
    3.ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆ
    4.åˆå¹¶å­ä»»åŠ¡çš„ç»“æœ
}
```

- Fork/Joinå®æˆ˜

ä»»åŠ¡ï¼šå®Œæˆå¯¹ä¸€äº¿ä¸ªè‡ªç„¶æ•°æ±‚å’Œ

æˆ‘ä»¬å…ˆä½¿ç”¨ä¸²è¡Œçš„æ–¹å¼å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
long result = LongStream.rangeClosed(1, 100000000)
                .reduce(0, Long::sum);
System.out.println("resultï¼š" + result);
```

ä½¿ç”¨Fork/Joinæ¡†æ¶å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class SumRecursiveTask extends RecursiveTask<Long> {
    private long[] numbers;
    private int start;
    private int end;

    public SumRecursiveTask(long[] numbers) {
        this.numbers = numbers;
        this.start = 0;
        this.end = numbers.length;
    }

    public SumRecursiveTask(long[] numbers, int start, int end) {
        this.numbers = numbers;
        this.start = start;
        this.end = end;
    }

    @Override
    protected Long compute() {
        int length = end - start;
        if (length < 20000) {  //å°äº20000ä¸ªå°±ä¸åœ¨è¿›è¡Œæ‹†åˆ†
            return sum();
        }
        SumRecursiveTask leftTask = new SumRecursiveTask(numbers, start, start + length / 2); //è¿›è¡Œä»»åŠ¡æ‹†åˆ†
        SumRecursiveTask rightTask = new SumRecursiveTask(numbers, start + (length / 2), end); //è¿›è¡Œä»»åŠ¡æ‹†åˆ†
        leftTask.fork(); //æŠŠè¯¥å­ä»»åŠ¡äº¤å‹ForkJoinPollçº¿ç¨‹æ± å»æ‰§è¡Œ
        rightTask.fork(); //æŠŠè¯¥å­ä»»åŠ¡äº¤å‹ForkJoinPollçº¿ç¨‹æ± å»æ‰§è¡Œ
        return leftTask.join() + rightTask.join(); //æŠŠå­ä»»åŠ¡çš„ç»“æœç›¸åŠ 
    }


    private long sum() {
        int sum = 0;
        for (int i = start; i < end; i++) {
            sum += numbers[i];
        }
        return sum;
    }


    public static void main(String[] args) {
        long[] numbers = LongStream.rangeClosed(1, 100000000).toArray();

        Long result = new ForkJoinPool().invoke(new SumRecursiveTask(numbers));
        System.out.println("resultï¼š" +result);
    }
}
```

> Fork/Joiné»˜è®¤çš„çº¿ç¨‹æ•°é‡å°±æ˜¯ä½ çš„å¤„ç†å™¨æ•°é‡ï¼Œè¿™ä¸ªå€¼æ˜¯ç”±`Runtime.getRuntime().available- Processors()`å¾—åˆ°çš„ã€‚ ä½†æ˜¯ä½ å¯ä»¥é€šè¿‡ç³»ç»Ÿå±æ€§`java.util.concurrent.ForkJoinPool.common. parallelism`æ¥æ”¹å˜çº¿ç¨‹æ± å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  `System.setProperty("java.util.concurrent.ForkJoinPool.common.parallelism","12");` è¿™æ˜¯ä¸€ä¸ªå…¨å±€è®¾ç½®ï¼Œå› æ­¤å®ƒå°†å½±å“ä»£ç ä¸­æ‰€æœ‰çš„å¹¶è¡Œæµã€‚ç›®å‰è¿˜æ— æ³•ä¸“ä¸ºæŸä¸ª å¹¶è¡ŒæµæŒ‡å®šè¿™ä¸ªå€¼ã€‚å› ä¸ºä¼šå½±å“åˆ°æ‰€æœ‰çš„å¹¶è¡Œæµï¼Œæ‰€ä»¥åœ¨ä»»åŠ¡ä¸­ç»å†é¿å…ç½‘ç»œ/IOæ“ä½œï¼Œå¦åˆ™å¯èƒ½ä¼šæ‹–æ…¢å…¶ä»–å¹¶è¡Œæµçš„è¿è¡Œé€Ÿåº¦

---

#### parallelStream
ä»¥ä¸Šæˆ‘ä»¬è¯´åˆ°çš„éƒ½æ˜¯åœ¨Java7ä¸­ä½¿ç”¨å¹¶è¡Œæµçš„æ“ä½œï¼ŒJava8å¹¶æ²¡æœ‰æ­¢æ­¥äºæ­¤ï¼Œä¸ºæˆ‘ä»¬æä¾›æ›´åŠ ä¾¿åˆ©çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯`parallelStream`ï¼›`parallelStream`åº•å±‚è¿˜æ˜¯é€šè¿‡Fork/Joinæ¡†æ¶æ¥å®ç°çš„ã€‚

- å¸¸è§çš„ä½¿ç”¨æ–¹å¼
1.ä¸²è¡Œæµè½¬åŒ–æˆå¹¶è¡Œæµ
```
LongStream.rangeClosed(1,1000)
                .parallel()
                .forEach(System.out::println);
```

2.ç›´æ¥ç”Ÿæˆå¹¶è¡Œæµ

```
 List<Integer> values = new ArrayList<>();
        for (int i = 0; i < 10000; i++) {
            values.add(i);
        }
        values.parallelStream()
                .forEach(System.out::println);
```

- æ­£ç¡®çš„ä½¿ç”¨parallelStream

æˆ‘ä»¬ä½¿ç”¨`parallelStream`æ¥å®ç°ä¸Šé¢çš„ç´¯åŠ ä¾‹å­çœ‹çœ‹æ•ˆæœï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public static void main(String[] args) {
    Summer summer = new Summer();
    LongStream.rangeClosed(1, 100000000)
            .parallel()
            .forEach(summer::add);
    System.out.println("resultï¼š" + summer.sum);

}

static class Summer {
    public long sum = 0;

    public void add(long value) {
        sum += value;
    }
}
```
è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![](https://raw.githubusercontent.com/silently9527/images/main/2932651169-5fc2019b12d96_articlex)

è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬å‘ç°è¿è¡Œçš„ç»“æœä¸æ­£ç¡®ï¼Œå¹¶ä¸”æ¯æ¬¡è¿è¡Œçš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
è¿™é‡Œå…¶å®å°±æ˜¯é”™ç”¨`parallelStream`å¸¸è§çš„æƒ…å†µï¼Œ`parallelStream`æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨è¿™ä¸ªé‡Œé¢ä¸­ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å»ä¿®æ”¹äº†å…±äº«å˜é‡sum, æ‰§è¡Œäº†`sum += value`æ“ä½œï¼Œè¿™ä¸ªæ“ä½œæœ¬èº«æ˜¯éåŸå­æ€§çš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å¹¶è¡Œæµæ—¶åº”è¯¥é¿å…å»ä¿®æ”¹å…±äº«å˜é‡ã€‚


ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼Œæ­£ç¡®ä½¿ç”¨`parallelStream`æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
long result = LongStream.rangeClosed(1, 100000000)
        .parallel()
        .reduce(0, Long::sum);
System.out.println("resultï¼š" + result);
```

åœ¨å‰é¢æˆ‘ä»¬å·²ç»è¯´è¿‡äº†fork/joinçš„æ“ä½œæµç¨‹æ˜¯ï¼šæ‹†å­éƒ¨åˆ†ï¼Œè®¡ç®—ï¼Œåˆå¹¶ç»“æœï¼›å› ä¸º`parallelStream`åº•å±‚ä½¿ç”¨çš„ä¹Ÿæ˜¯fork/joinæ¡†æ¶ï¼Œæ‰€ä»¥è¿™äº›æ­¥éª¤ä¹Ÿæ˜¯éœ€è¦åšçš„ï¼Œä½†æ˜¯ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°`Long::sum`åšäº†è®¡ç®—ï¼Œ`reduce`åšäº†åˆå¹¶ç»“æœï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å»åšä»»åŠ¡çš„æ‹†åˆ†ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹è‚¯å®šæ˜¯`parallelStream`å·²ç»å¸®æˆ‘ä»¬å®ç°äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å¿…é¡»çš„è¯´è¯´`Spliterator`

`Spliterator`æ˜¯Java8åŠ å…¥çš„æ–°æ¥å£ï¼Œæ˜¯ä¸ºäº†å¹¶è¡Œæ‰§è¡Œä»»åŠ¡è€Œè®¾è®¡çš„ã€‚

```
public interface Spliterator<T> {
    boolean tryAdvance(Consumer<? super T> action);

    Spliterator<T> trySplit();

    long estimateSize();

    int characteristics();
}
```
tryAdvance: éå†æ‰€æœ‰çš„å…ƒç´ ï¼Œå¦‚æœè¿˜æœ‰å¯ä»¥éå†çš„å°±è¿”å›tureï¼Œå¦åˆ™è¿”å›false

trySplit: å¯¹æ‰€æœ‰çš„å…ƒç´ è¿›è¡Œæ‹†åˆ†æˆå°çš„å­éƒ¨åˆ†ï¼Œå¦‚æœå·²ç»ä¸èƒ½æ‹†åˆ†å°±è¿”å›null

estimateSize: å½“å‰æ‹†åˆ†é‡Œé¢è¿˜å‰©ä½™å¤šå°‘ä¸ªå…ƒç´ 

characteristics: è¿”å›å½“å‰Spliteratorç‰¹æ€§é›†çš„ç¼–ç 

---

#### æ€»ç»“
1. è¦è¯æ˜å¹¶è¡Œå¤„ç†æ¯”é¡ºåºå¤„ç†æ•ˆç‡é«˜ï¼Œåªèƒ½é€šè¿‡æµ‹è¯•ï¼Œä¸èƒ½é çŒœæµ‹ï¼ˆæœ¬æ–‡ç´¯åŠ çš„ä¾‹å­åœ¨å¤šå°ç”µè„‘ä¸Šè¿è¡Œäº†å¤šæ¬¡ï¼Œä¹Ÿå¹¶ä¸èƒ½è¯æ˜é‡‡ç”¨å¹¶è¡Œæ¥å¤„ç†ç´¯åŠ å°±ä¸€å®šæ¯”ä¸²è¡Œçš„å¿«å¤šå°‘ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡å¤šæµ‹è¯•ï¼Œç¯å¢ƒä¸åŒå¯èƒ½ç»“æœå°±ä¼šä¸åŒï¼‰
2. æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”è®¡ç®—é€»è¾‘ç®€å•ï¼Œé€šå¸¸ä¸å»ºè®®ä½¿ç”¨å¹¶è¡Œæµ
3. éœ€è¦è€ƒè™‘æµçš„æ“ä½œæ—¶é—´æ¶ˆè€—
4. åœ¨æœ‰äº›æƒ…å†µä¸‹éœ€è¦è‡ªå·±å»å®ç°æ‹†åˆ†çš„é€»è¾‘ï¼Œå¹¶è¡Œæµæ‰èƒ½é«˜æ•ˆ


---

> æ„Ÿè°¢å¤§å®¶å¯ä»¥è€å¿ƒåœ°è¯»åˆ°è¿™é‡Œã€‚
å½“ç„¶ï¼Œæ–‡ä¸­æˆ–è®¸ä¼šå­˜åœ¨æˆ–å¤šæˆ–å°‘çš„ä¸è¶³ã€é”™è¯¯ä¹‹å¤„ï¼Œæœ‰å»ºè®®æˆ–è€…æ„è§ä¹Ÿéå¸¸æ¬¢è¿å¤§å®¶åœ¨è¯„è®ºäº¤æµã€‚
æœ€åï¼Œå¸Œæœ›æœ‹å‹ä»¬å¯ä»¥ç‚¹èµè¯„è®ºå…³æ³¨ä¸‰è¿ï¼Œå› ä¸ºè¿™äº›å°±æ˜¯æˆ‘åˆ†äº«çš„å…¨éƒ¨åŠ¨åŠ›æ¥æºğŸ™
